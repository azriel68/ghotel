<?
	require("../includes/inc.php");

	is_logged();

	entete("Gestion hotels");

	if(isset($_REQUEST['action'])){
		$action=$_REQUEST['action'];
	}
	else{
		$action='LIST';
	}

	$sess_name=isset($_REQUEST['sess_name'])?$_REQUEST['sess_name']:gen_sess_name("hotel");

	$db=new Tdb;
	switch($action){
		case 'SAVE':
			$h = & $_SESSION[$sess_name];
			
			if(is_hotel_select()){
				menu();
			} else { menu_off(); }
			
			valider($h);
			enregistrer($db,$h);

			fiche($h, $sess_name);

			break;

		case 'DELETE':
			$h = & $_SESSION[$sess_name];
			$h->delete($db);
			
			if(is_hotel_select()){
				menu();
			} else { menu_off(); } 
			
			liste();

			break;
		case 'VIEW':
			unset_session('hotel');
			
			$_SESSION[$sess_name]=new THotel();
			$h = & $_SESSION[$sess_name];
			$h->load($db, $_REQUEST['id']);

			$_SESSION[SESS_HOTEL] = $h;

      if(get_hotel_access()) {
        menu();
			  fiche($h,$sess_name);
      }
      else{
        menu_off();
      
        erreur("Vous n'avez pas accès à cet hôtel");
        $t=new TTbl;
        print "<p align=\"center\">";
        print $t->link("Retour au choix de l'hôtel", $_SERVER['PHP_SELF']."?action=LIST","button");
        print "</p>";
      }

			
			break;
		case 'NEW':
			$_SESSION[$sess_name]=new THotel();
			$h = & $_SESSION[$sess_name];
			
			if(is_hotel_select()){
				menu();
			} else { menu_header(); }
			
			fiche($h,$sess_name);
			break;
		case 'LIST':
					
			if(is_hotel_select()){
				menu();
			} else { menu_header(); }
			
			liste();
			break;
		default:
			erreur("inconnu : ".$action);
	} // switch
	$db->close();

	pied_de_page();


function valider(&$h){

	$h->id_utilisateur = get_sess_user_id();
	$h->id_groupe = get_sess_user_group_id();
	$h->nom = $_POST['nom'];
	$h->adresse = $_POST['adresse'];
	$h->cp = $_POST['cp'];
	$h->ville = $_POST['ville'];
	$h->email = $_POST['email'];
	$h->site = $_POST['site'];
	$h->tva = $_POST['tva'];
	$h->siren = $_POST['siren'];
	$h->siret = $_POST['siret'];
	$h->ape = $_POST['ape'];
	$h->capital = _fstring($_POST['capital']);
	$h->telephone = $_POST['telephone'];
	$h->fax = $_POST['fax'];
	$h->responsable = $_POST['responsable'];
	$h->rcs = $_POST['rcs'];
	$h->banque = $_POST['banque'];
	$h->etab = $_POST['etab'];
	$h->guichet = $_POST['guichet'];
	$h->compte = $_POST['compte'];
	$h->cle = $_POST['cle'];
	$h->note = $_POST['note'];

}
function enregistrer(&$db, &$h){

	if($h->nom!="" && $h->adresse!="" && $h->cp!="" && $h->ville!=""){
		$h->save($db);
		info("Fiche enregistrée");

		$_SESSION[SESS_HOTEL] = $h;
	}
	else{
		erreur("Le nom, l'adresse, le code postal et la ville sont obligatoires");
	}


}
function fiche(&$h,$sess_name){

	$formname="form_hotel";
?>
<script language="javascript">
function go_liste(){
 	document.forms['<?=$formname?>'].elements['action'].value='LIST';
 	document.forms['<?=$formname?>'].submit();
}
function valider(){
 	document.forms['<?=$formname?>'].elements['action'].value='SAVE';
 	document.forms['<?=$formname?>'].submit();
}
function supprimer(){
	if(window.confirm('Voulez-vous vraiment supprimer cette fiche ?')){
	document.forms['<?=$formname?>'].elements['action'].value='DELETE';
 	document.forms['<?=$formname?>'].submit();
	}
}

</script>
<?
	$form=new TForm($_SERVER['PHP_SELF'], $formname);
	echo $form->hidden("sess_name", $sess_name);
	echo $form->hidden("action", "SAVE");

	$t=new TTbl;
	$t->beg_tbl('formcadre',800,2,'','center');
	$t->beg_line("listheader");
	$t->Cell(
		"Fiche hotel"
	,-1,'',2);
	$t->end_line();
	$t->beg_line();
	$t->Cell("Nom");
	$t->Cell( $form->texte('','nom',$h->nom, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Adresse");
	$t->Cell( $form->texte('','adresse',$h->adresse, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Code postal");
	$t->Cell( $form->texte('','cp',$h->cp, 10, 10) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Ville");
	$t->Cell( $form->texte('','ville',$h->ville, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("E-mail");
	$t->Cell( $form->texte('','email',$h->email, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Site");
	$t->Cell( $form->texte('','site',$h->site, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("TVA");
	$t->Cell( $form->texte('','tva',$h->tva, 5, 5,'','textfloat')." %" );
	$t->end_line();
	$t->beg_line();
	$t->Cell("SIREN");
	$t->Cell( $form->texte('','siren',$h->siren, 20, 20) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("APE");
	$t->Cell( $form->texte('','ape',$h->ape, 5, 10) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("SIRET");
	$t->Cell( $form->texte('','siret',$h->siret, 20, 20) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Capital");
	$t->Cell( $form->texte('','capital',_fnumber($h->capital,0), 20, 20,'','textfloat')." €" );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Téléphone");
	$t->Cell( $form->texte('','telephone',$h->telephone, 20, 20) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Fax");
	$t->Cell( $form->texte('','fax',$h->fax, 20, 20) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Responsable");
	$t->Cell( $form->texte('','responsable',$h->responsable, 60, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("RCS");
	$t->Cell( $form->texte('','rcs',$h->rcs, 20, 30) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Banque");
	$t->Cell( $form->texte('','banque',$h->banque, 60, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("RIB");
	$t->Cell(
		$form->texte('','etab',$h->etab, 10, 10)
		.$form->texte('','guichet',$h->guichet, 10, 10)
		.$form->texte('','compte',$h->compte, 30, 50)
		.$form->texte('','cle',$h->cle, 2, 2) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Note");
	$t->Cell( $form->zonetexte('','note',$h->note, 77) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Modification");
	$t->Cell($h->get_dtmaj());
	$t->end_line();
	$t->beg_line();
	$t->Cell("Création");
	$t->Cell($h->get_dtcre());
	$t->end_line();

	$t->end_tbl();

	echo "<p align=\"center\">";
/*	echo $form->bt("Liste","bt_retour"," onClick=\"go_liste()\"");
	echo $form->bt("Valider","bt_valid"," onClick=\"Valider()\"");*/

	echo $t->link("Liste","javascript:go_liste()","button");

	if($h->id>0)echo $t->link("Supprimer","javascript:supprimer()","button_delete");
	echo $t->link("Valider","javascript:valider()","button_valid");

	echo "</p>";

	echo $form->end_form();
}

function liste(){
	$listname='dblist1';
	$lst=new TListView($listname);

	//titre du référentiel
	echo "<h1>Liste des hotels</h1>";

	$t=new TTbl;

	echo "<p align=\"center\">".$t->link("Ajouter un hotel","?action=NEW","button")."</p>";

	/**
	 * A prévoir cette liste va devenir un tableau de controle
	 * abandon de l'objet liste
	 * Alexis ALGOUD 03/03/2007 20:41:37
	 **/


	//requête
	$sql = "SELECT id as 'ID', nom as 'Nom', adresse as 'Adresse', cp as 'Code postal'
	, ville as 'Ville', email as 'E-Mail', site as 'Site', tva as 'TVA', dt_cre as 'Création'
	FROM hot_hotel WHERE id_groupe=".get_sess_user_group_id();

	$ordercolumn = isset($_REQUEST["orderColumn"])?$_REQUEST["orderColumn"]: 'Nom';
	$ordertype = isset($_REQUEST["orderTyp"])?$_REQUEST["orderTyp"]:"A";
	$pagenumber = isset($_REQUEST["pageNumber"])?$_REQUEST["pageNumber"]:0;

	//initialisation de la requête
	$lst->Set_Query($sql);
	//chargement de la requête
	$lst->Load_query($ordercolumn,$ordertype); // on charge la requête
	$lst->Set_pagenumber($pagenumber);

	$lst->Set_Key("ID",'id');
	$lst->Set_columnType('Création','DATE');

	$lst->Set_OnClickAction('OpenForm',"?action=VIEW");
	$lst->Set_nbLinesPerPage(30);

	//Affichage de la liste
	echo $lst->Render();

}
?>
