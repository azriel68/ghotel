<?
/********************************************************************
 * Alexis ALGOUD													*
 * 08/11/2006 18:43:32												*
 * IHM de gestion des paramètres										*
 ********************************************************************/

/**
 * Inclusion des classes
 * Vérification du log de l'utilisateur
 * Affichage de l'en-tête de page et du menu
 * Récupération de l'action à effectuer (LIST par défaut)
 */
	require("../includes/inc.php");
	is_logged();
	
	if(!is_admin()) {
		entete("Accès refusé");
		erreur ("Vous n'êtes pas autorisé à afficher cette page");
		exit();
	}
	
	entete("Gestion paramètres");

	if(is_hotel_select()) {	menu_admin();	}

	if(isset($_REQUEST['action'])){
		$action=$_REQUEST['action'];
	}
	else{
		$action='LIST';
	}

/**
 * Récupération ou création de la session paramètre
 * Création d'un accès à la base de données
 * Appels aux fonctions suivant l'action
 */
	$sess_name=isset($_REQUEST['sess_name'])?$_REQUEST['sess_name']:gen_sess_name("param");
	$db=new Tdb();

	
	
	switch($action) {
		case 'SAVE':
			$TParam=& $_SESSION[$sess_name];
			
			valider($db,$TParam);
			enregistrer($db,$TParam);
			affiche($db, $TParam, $sess_name);

			break;
		case 'LIST':
	
			/*$req = new TRequete();
			$Tab = array();
			$Tab = $req->liste_tous_param($db);
			*/
			
      $_SESSION[$sess_name]=array();
			$TParam=& $_SESSION[$sess_name];
			
      load_all_param($db, $TParam);
			
      affiche($db, $TParam, $sess_name);

			break;
		default:
			erreur("L'action ".$action." est inconnue");
	} // switch

/**
 * Fermeture de la connexion à la base de données
 * Affichage du pied de page
 */
	$db->close();
	pied_de_page();

/************************************
 * FONCTIONS LOCALES				*
 ************************************/
function load_all_param(&$db,  &$TParam){
	$TParam[0]=new TNumerotation;
  $TParam[0]->load($db, "FACTURE");
	
	$TParam[1]=new TNumerotation;
  $TParam[1]->load($db, "DEVIS");

}
/**
 * Récupération des champs du formulaire envoyés par POST
 */
function valider(&$db, &$TParam) {
	
	$n = & $TParam[0];
	$Tab = & $_REQUEST['TParam'][0];
	
  $n->prefixe = $Tab['prefixe'];
  $n->postfixe = $Tab['postfixe'];
  $n->numero = $Tab['numero'];
  $n->longueur = $Tab['longueur'];

	$n = & $TParam[1];
	$Tab = & $_REQUEST['TParam'][1];
	
  $n->prefixe = $Tab['prefixe'];
  $n->postfixe = $Tab['postfixe'];
  $n->numero = $Tab['numero'];
  $n->longueur = $Tab['longueur'];
}


/**
 * Vérification des champs saisis
 * Sauvegarde du paramètre dans la base
 */
function enregistrer(&$db, &$TParam) {
		
		foreach($TParam as $k=>$v){
      
      $p = & $TParam[$k];
			$p->save($db);
			
    }
    
}

/**
 * Affichage des paramètres
 */
function affiche(&$db, &$TParam, $sess_name) {
	$formname="form_param";
?>

<script language="javascript">
function valider(){
 	document.forms['<?=$formname?>'].elements['action'].value='SAVE';
 	document.forms['<?=$formname?>'].submit();
}
</script>

<?
	$form=new TForm($_SERVER['PHP_SELF'], $formname);
	echo $form->hidden("action", "SAVE");
	echo $form->hidden("sess_name",$sess_name);
	
	$t=new TTbl();

	$t->beg_tbl('formcadre',800,2,'','center');
	$t->beg_line("listheader");
	$t->Cell("Paramètres",-1,'',4);
	$t->end_line();
	

  $n = & $TParam[0];
  $t->beg_line("listheader");
	$t->Cell("Numéro de facture",-1,'',4);
	$t->end_line();
  $t->beg_line();
  $t->Cell($form->texte('Préfixe', 'TParam[0][prefixe]', $n->prefixe, 3,10) );
  $t->Cell($form->texte('Prochain numéro', 'TParam[0][numero]', $n->numero, 10,20) );
  $t->Cell($form->texte('Longueur (sans préfixe) : ', 'TParam[0][longueur]', $n->longueur, 3,10) );
  $t->Cell($form->texte('Posfixe : ', 'TParam[0][postfixe]', $n->postfixe, 3,10) );
  $t->end_line();

  $n = & $TParam[1];
  $t->beg_line("listheader");
	$t->Cell("Numéro de devis",-1,'',4);
	$t->end_line();
  $t->beg_line();
  $t->Cell($form->texte('Préfixe', 'TParam[1][prefixe]', $n->prefixe, 3,10) );
  $t->Cell($form->texte('Prochain numéro', 'TParam[1][numero]', $n->numero, 10,20) );
  $t->Cell($form->texte('Longueur (sans préfixe) : ', 'TParam[1][longueur]', $n->longueur, 3,10) );
  $t->Cell($form->texte('Posfixe : ', 'TParam[1][postfixe]', $n->postfixe, 3,10) );
  $t->end_line();


	$t->end_tbl();

	echo "<p align=\"center\">";
	echo $t->link("Valider","javascript:valider()","button_valid");
	echo "</p>";

	echo $form->end_form();
}

function _affiche_param (&$p, &$form) {
	$t = new TTbl();
	
	$t->beg_line();
	$t->Cell($p->id);
	$t->Cell($p->description);
	//print_r($p);
	switch ($p->type) {
		case "VALEUR_N":
		case "VALEUR_F":
			$t->Cell($form->texte('','param['.$p->id.']',$p->get_valeur(),20,20));
			break;
		case "VALEUR_S":
			$t->Cell($form->texte('','param['.$p->id.']',$p->get_valeur(),20,255));
			break;
		case "VALEUR_T":
			$t->Cell($form->zonetexte('','param['.$p->id.']',$p->get_valeur(),50));
			break;
		case "VALEUR_D":
			$t->Cell($form->texte('','param['.$p->id.']',$p->get_valeur(),10,10));
			break;	
		default:
			$t->Cell("Erreur de chargement du paramètre");
			break;
	}

	$t->end_line();
}

?>