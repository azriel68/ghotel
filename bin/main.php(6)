<?
	require("../includes/inc.php");

  if(isset($_REQUEST['action'])){
		$action=$_REQUEST['action'];
	}
	else{
		$action='VIEW';
	}

  if($action=='VIEW' && is_logged(true)){
      header("location:hotel.php");
  }





	$db=new Tdb;
	
	
//$db->db->debug=true;
	switch($action){
	
	  case 'NEWACCOUNT':
	   $utilisateur = new TUtilisateur;
	   $utilisateur->login = $_REQUEST['login'];
	   $utilisateur->email = $_REQUEST['email']; 
	   
	   $chklogin = $utilisateur->check_login($db);
	   
	   if($_REQUEST['email']!="" && $_REQUEST['group_name']!="" 
            && $chklogin){
      
      $groupe=new TGroupe;
      $groupe->nom = $_REQUEST['group_name'];
      $groupe->save($db);
      
      $utilisateur->id_groupe = $groupe->id;
      $utilisateur->nom = $groupe->nom;
      $utilisateur->make_password();
      
      
      
      $utilisateur->send_mail_account();
      
      $utilisateur->save($db);
      
      entete("Création d'un nouveau compte terminé"); 
      //menu_off();        
      ?>
      <div class="information">
      Votre inscription a bien été prise en compte. Un email de confirmation avec vos
      informations d'identification va vous parvenir dans quelques minutes. Vous pourrez
      ensuite vous identifier grace au formulaire ci-dessous.
      </div>
      <?     
      
      fiche();
     }
     else{
      $TErr=array();
      if($_REQUEST['email']=="")$TErr['email']='vide';
      if($_REQUEST['group_name']=="")$TErr['groupe']='vide';
      if(!$chklogin)$TErr['login']='erreur';
      entete("Création d'un nouveau compte");
      //menu_off();
      inscription($TErr);
     }
	  
	   
	   break;
	
	  case 'ERROR_ID':
	   entete("Echec session - Réidentifiez-vous");
	     ?>
      <div class="information">
      Vous êtes resté trop lontemps inactif, pour plus de sécurité votre session a
      été automatiquement fermée. Merci de vous réidentifier.
      </div>
      <?   
      fiche();
      
	   break;
	
		case 'DECONNEXION':
		  entete("Identifiez-vous");
			//menu_off();
			info("Vous êtes maintenant déconnecté");
			deconnexion();
			fiche();
			break;
		case 'LOGIN':
			$_SESSION[SESS_USER]=new TUtilisateur;
			$u=& $_SESSION[SESS_USER];
			if($u->login($db,$_REQUEST['login'], $_REQUEST['password'])){
			  $_SESSION[SESS_GRP]=new TGroupe;
			  $_SESSION[SESS_GRP]->load($db, $u->id_groupe);  
			   
				$u->save_connexion($db);
				$_SESSION[SESS_GRP]->save_connexion($db);

				header("location:hotel.php");
			}
			else{
				entete("Identifiez-vous");
				//menu_off();
				erreur("Login ou mot de passe incorrect");

				deconnexion();
				fiche();
			}

			break;
		case 'VIEW':
    
			entete("Identifiez-vous/Inscrivez-vous");
		
			//menu_off();
			fiche();
			inscription();
			break;
		default:
			erreur("inconnu : ".$action);
	} // switch

	$db->close();
	pied_de_page();


function inscription($TErr=array()){
  echo "<br /><br /><h1 class=\"titre\">Vous souhaitez devenir utilisateur de Ghôtel, inscrivez-vous</h1>";
  $formname="forminscription";
	$form=new TForm($_SERVER['PHP_SELF'], $formname);
	echo $form->hidden("action","NEWACCOUNT");
	if(isset($TErr['login']) && $TErr['login']=='erreur'){
      ?>
      <div class="information_erreur">
      Le login que vous avez spécifié est soit trop court (minimum 3 caractères), 
      soit déjà utilisé. Veuillez le modifier en conséquence. Merci.
      </div>
      <?  
  }
	
	if(isset($TErr['email']) && $TErr['email']=='vide'){
      ?>
      <div class="information_erreur">
      Votre adresse mail est obligatoire pour finaliser votre inscription.
      </div>
      <?  
  }
	if(isset($TErr['groupe']) && $TErr['groupe']=='vide'){
      ?>
      <div class="information_erreur">
      Un nom de groupe est obligatoire pour finaliser votre inscription.
      </div>
      <?  
  }
	
	
?>
<script language="javascript">
function inscription(){
  //alert("L'inscription sera disponible d'ici quelques heures :)");
 	document.forms['<?=$formname?>'].elements['action'].value='NEWACCOUNT';
 	document.forms['<?=$formname?>'].submit();
}

</script>

<div class="information">
Pour créer un nouveau compte GHôtel, saisissez les informations demandées ci-après.
Veillez à donner une adresse mail valide. Un mail de confirmation contenant votre mot de passe
(que vous pourrez modifier à votre convenance par la suite) vous sera envoyé à la
fin de cette procédure.
</div>
<?	
	
  $t=new TTbl;
  
  $t->beg_tbl('formcadre',800,2,'','center');
	$t->beg_line("listheader");
	$t->Cell("Création d'un compte",-1,'',2);
  $t->end_line();
  
  $t->beg_line();
  $t->Cell("Choisissez votre identifiant");
  $t->Cell( $form->texte("","login",'auto',30,255));
  $t->end_line();
  
  $t->beg_line();
  $t->Cell("Votre adresse mail de contact");
  $t->Cell( $form->texte("","email",'auto',60,255));
  $t->end_line();
  
  $t->beg_line();
  $t->Cell("Le nom de votre société/groupe/organisme<br>(à défaut, votre nom de famille)");
  $t->Cell( $form->texte("","group_name",'auto',60,255));
  $t->end_line();
  $t->end_tbl();
    
  echo "<p align=\"center\">";
	echo $t->link("M'inscrire","javascript:inscription()","button");
	echo "</p>";

	echo $form->btsubmithidden('','btvalidation');


}

function fiche(){

  echo "<h1 class=\"titre\">Vous avez un compte Ghôtel</h1>";

	$formname="formlogin";
	$form=new TForm($_SERVER['PHP_SELF'], $formname);
	echo $form->hidden("action","LOGIN");
?>
<script language="javascript">
function connexion(){
 	document.forms['<?=$formname?>'].elements['action'].value='LOGIN';
 	document.forms['<?=$formname?>'].submit();
}

</script>
<?

	$t=new TTbl;
	
	$t->beg_tbl('formcadre',-1,2,'','center');
	$t->beg_line("listheader");
	$t->Cell("Identifiez-vous",-1,'',2);
	$t->end_line();
	$t->beg_line();
	$t->Cell("Votre identifiant ",-1,'','','right');
	$t->Cell( $form->texte("","login",isset($_REQUEST['login'])?$_REQUEST['login']:"",30,255)
.(isset($_REQUEST['login'])?"":"<script language=\"javascript\">document.forms['$formname'].elements['login'].focus();</script>") );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Votre mot de passe ");
	$t->Cell( $form->password("","password","",30,255)
.(isset($_REQUEST['login'])?"<script language=\"javascript\">document.forms['$formname'].elements['password'].focus();</script>":"") );
	$t->end_line();
	$t->end_tbl();

	echo "<p align=\"center\">";
	echo $t->link("Me connecter","javascript:connexion()","button");
	echo "</p>";

	echo $form->btsubmithidden('','btvalidation');

	echo $form->end_form();

}
?>
