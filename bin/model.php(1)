<?
	require("../includes/inc.php");
	require("../includes/class.pdfmaker.php");
	is_logged();

 	if(!is_admin()) {
		entete("Accès refusé");
		erreur ("Vous n'êtes pas autorisé à afficher cette page");
		exit();
	}

	entete("Gestion de modèles de document");
	
	if(is_hotel_select()){
		menu_admin();
	}

	if(isset($_REQUEST['action'])){
		$action=$_REQUEST['action'];
	}
	else{
		$action='LIST';
	}

	$sess_name=isset($_REQUEST['sess_name'])?$_REQUEST['sess_name']:gen_sess_name("model");
	
	$db=new Tdb;

	switch($action){
		case 'DELETE':
			$c = & $_SESSION[$sess_name];
			$c->delete($db);

			liste($id_hotel);

			break;
		case 'VIEW':
			$_SESSION[$sess_name]=new TChambre();
			$c = & $_SESSION[$sess_name];
			$c->load($db, $_REQUEST['id']);


			fiche($c,$sess_name);
			break;
		case 'NEW':
		
      liste($db);
			break;
		case 'LIST':
			liste($db);
			break;
		default:
			erreur("inconnu : ".$action);
	} // switch
	$db->close();

	pied_de_page();


function valider(&$c){



	$c->nb_lit = $_POST['nb_lit'];
	$c->prestation = $_POST['prestation'];
	$c->orientation = $_POST['orientation'];
	$c->situation = $_POST['situation'];
	$c->prix = $_POST['prix'];
	$c->num = $_POST['num'];
	$c->id_categorie = $_POST['id_categorie'];
	$c->id_hotel =get_sess_hotel_id();

  if(isset($_POST['TPrixSaison'])){

		$TPrixSaison = &$_POST['TPrixSaison'];
		$keys=array_keys($TPrixSaison);
		$nb=count($keys);
		for($i = 0; $i < $nb; $i++){

			$k = $keys[$i];
			$c->TPrixSaison[$k]->set_dtdeb($TPrixSaison[$k]['dt_deb']);
			$c->TPrixSaison[$k]->set_dtfin($TPrixSaison[$k]['dt_fin']);
			$c->TPrixSaison[$k]->prix =$TPrixSaison[$k]['prix'];

		} // for

	}

}
function enregistrer(&$db, &$c){

	if($c->nb_lit!="" && $c->prix!="" && $c->num!=""){
		$c->save($db);
		info("Fiche enregistrée");
	}
	else{
		erreur("Tous les champs sont obligatoires");
	}


}


function fiche(&$c,$sess_name){

	$formname="form_chambres";
?>
<script language="javascript">
function go_liste(){
 	document.forms['<?=$formname?>'].elements['action'].value='LIST';
 	document.forms['<?=$formname?>'].submit();
}
function valider(){
 	document.forms['<?=$formname?>'].elements['action'].value='SAVE';
 	document.forms['<?=$formname?>'].submit();
}
function supprimer(){
	if(window.confirm('Voulez-vous vraiment supprimer cette fiche ?')){
	document.forms['<?=$formname?>'].elements['action'].value='DELETE';
 	document.forms['<?=$formname?>'].submit();
	}
}
function add_prix () {
	document.forms['<?=$formname?>'].elements['action'].value='ADD_PRIX';
 	document.forms['<?=$formname?>'].submit();

}
function del_prix (p1) {
	document.forms['<?=$formname?>'].elements['action'].value='DEL_PRIX';
 	document.forms['<?=$formname?>'].elements['p1'].value=p1;
 	document.forms['<?=$formname?>'].submit();

}
</script>
<?
	$form=new TForm($_SERVER['PHP_SELF'], $formname);
	echo $form->hidden("sess_name", $sess_name);
	echo $form->hidden("action", "SAVE");

	$t=new TTbl;
	$t->beg_tbl('formcadre',800,2,'','center');
	$t->beg_line("listheader");
	$t->Cell(
		"Fiche chambre"
	,-1,'',2);
	$t->end_line();
	$t->beg_line();
	$t->Cell("Numéro");
	$t->Cell( $form->texte('','num',$c->num, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Nombre de lit");
	$t->Cell( $form->texte('','nb_lit',$c->nb_lit, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Prestation");
	$t->Cell( $form->texte('','prestation',$c->prestation, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Orientation");
	$t->Cell( $form->texte('','orientation',$c->orientation, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Situation");
	$t->Cell( $form->texte('','situation',$c->situation, 80, 255) );
	$t->end_line();
	$t->beg_line();
	$t->Cell("Catégorie");
	$t->Cell($form->hidden("id_categorie",$c->id_categorie)
	.$form->texteRO("", "lib_categorie", isset($c->TCategorie[$c->id_categorie])?$c->TCategorie[$c->id_categorie]:"", 60)
	.$t->link("choisir","javascript:showPopup('../dlg/lst_categorie.php','$formname','id_categorie;lib_categorie;prix')","lien","","ico_browse.gif")
	);
	$t->beg_line();
	$t->Cell("Tarif<br><small> (ou tarif par défaut)</small>");
	$t->Cell( $form->texte('','prix',$c->prix, 80, 255) );
	$t->end_line();
	
  $t->beg_line("listheader");
	$t->Cell(
		"Les tarifs saisonniers ".$t->link("ajouter","javascript:add_prix()","lien","","ico_xplus.gif")
	,-1,'',2);
	$t->end_line();
	$t->beg_line();
	$t->beg_Cell(-1,'',2);
	_fiche_prix($c, $form);
	$t->end_cell();
	$t->end_line();

	$t->end_line();
	$t->beg_line();
	$t->Cell("Modification");
	$t->Cell($c->get_dtmaj());
	$t->end_line();
	$t->beg_line();
	$t->Cell("Création");
	$t->Cell($c->get_dtcre());
	$t->end_line();

	$t->end_tbl();

	echo "<p align=\"center\">";
/*	echo $form->bt("Liste","bt_retour"," onClick=\"go_liste()\"");
	echo $form->bt("Valider","bt_valid"," onClick=\"Valider()\"");*/

	echo $t->link("Liste","javascript:go_liste()","button");

	if($c->id>0)echo $t->link("Supprimer","javascript:supprimer()","button_delete");
	echo $t->link("Valider","javascript:valider()","button_valid");

	echo "</p>";

	echo $form->end_form();
}

function liste(&$db){
	$listname='dblist1';
	$lst=new TListView($listname);
	$formname="form_model";
	
?>
<script language="javascript">

function downmodel (id_model) {
	
	document.location.href="../scripts/down_model.php?id_model="+id_model+"&id_hotel=<?=get_sess_hotel_id()?>"
	
}
</script><?
	//titre du référentiel
	echo "<h1>Liste des modèles de document disponible</h1>";

	$t=new TTbl;

  $form=new TForm("",$formname,"POST",true);
	echo "<p align=\"center\">"
	.$form->fichier("Votre fichier modèle","f_model","","")
  .$t->link("Ajouter un modèle","?action=NEW","button")
  ."</p>";

  $r=new TRequete;
	$TModel = $r->get_model($db, get_sess_hotel_id());
	
	 $nb=count($TModel);
	
	 $t->beg_tbl('formcadre',800,2,'','center');
	 $t->beg_line("listheader");
	 $t->Cell("Libelle");
	 $t->Cell("Langue de référence");
	 $t->Cell("Sur document");
	 $t->Cell("S.");
	 $t->end_line();
	

	 $class="L1";
   for ($i=0; $i<$nb; $i++) {
    	
    	$m=new TModel;
    	$m->load($db, $TModel[$i]);
    	
    	$t->beg_line($class);
    	
    		
      if($m->id<0){
        $t->Cell($t->link($m->libelle,"javascript:downmodel(".$m->id.")"));
        $t->Cell($m->TLangue[$m->langue]);
      	$t->Cell($m->TType[$m->type]);
      	$t->Cell("");
      	
      }
    	else{
    	  $t->Cell(
    	  $form->texte("","TModel[$i][libelle]",$m->libelle,60,255)
        .$t->link("#","javascript:downmodel(".$m->id.")")
        );
        
        $t->Cell(
          $form->combo("", "TModel[$i][langue]", $m->TLangue, $m->langue)
        );
      	$t->Cell(
          $form->combo("", "TModel[$i][type]", $m->TType, $m->type)
        );
      	$t->Cell("X");
      
      }
      $t->end_line();
    	
    	$class=($class=="L1")?"L2":"L1";
   }
   
   $t->end_tbl();

  echo $form->end_form();
}
?>
